#!/usr/bin/env ruby

require 'bagit'
require 'docopt'

doc = <<DOCOPT
BagIt.

Usage: 
  bagit add [-f <file>...] [-t <tagfile>...] BAGPATH
  bagit delete [-f <file>...] [-t <tagfile>...] BAGPATH
  bagit remove [-t <tagfile>...] BAGPATH
  bagit validate [-o] BAGPATH 
  bagit manifest [-T] BAGPATH
  bagit list [--tags | --all] BAGPATH 
  bagit -h | --version

Options:
  -h --help      Show this help screen.
  --version      Show version.
  -f <file>      File to add to/delete from bag. Repeatable.
  -t <tag_file>  Tag (metadata) file to add to/delete/remove from bag. Repeatable.
  -T             Force regeneration of tag manifest files.
  -o --oxum      Validate against oxum only (quick validate).
  --tags         List tag files.
  --all          List all data and tag files.

DOCOPT

  # Possible commands for bag-info write
  # 
  # bagit new [--source-organization <org>] [--organization-address <org-addr>] [--contact-name <contact>] 
  #             [--contact-phone <phone>] [--contact-email <email>] [--external-description <ext-desc>] 
  #             [--external-identifier <ext-id>] [--group-identifier <group-id>] [--count <count>] 
  #             [--internal-sender-identifier <sender-id>] [--internal-sender-description <sender-desc>] 
  #             [--bag-info-entry <label> <value>] [-f <file>...] [-t <tagfile>...] BAGPATH

begin
  opts = Docopt::docopt(doc, version: BagIt::VERSION)
  
  bag = BagIt::Bag.new(opts['BAGPATH'])

  #####################################
  # commands that don't alter the bag #
  #####################################
  if opts['validate']
    if opts['--oxum']
      puts bag.valid_oxum?.to_s
    else
      puts bag.valid?.to_s
    end
    # validation commands MUST NOT change manifest or bag-info files
    exit
  end

  if opts['list']
    files = bag.bag_files
    if opts['--tags']
      files = bag.tag_files
    elsif opts['--all']
      files = bag.bag_files + bag.tag_files
    end
    files.each { |f| puts f }
    # quit here, too
    exit
  end


  ######################################
  # commands that may cause data loss! #
  ######################################

  #TODO: implement delete for data and tag files; remove for tag files.

  # handle add/delete bag data files
  unless opts['-f'].nil? 
    #TODO: add files in nested directories
    opts['-f'].each { |datafile|
      begin
        if opts['add'] or opts['new']
          bag.add_file(File.basename(datafile), datafile)
        elsif opts['delete']
          bag.remove_file(File.basename(datafile))
        end
      rescue Exception => e
        puts "Failed operation on bag file: #{e.message}"
      end
    }  
  end

  # handle adding tag files
  unless opts['-t'].nil? 
    #TODO: add files in nested directories
    opts['-t'].each { |tagfile|
      begin
        if opts['add'] or opts['new']
          # if it does, try to manifest it
          if File.exist?(File.join(bag.bag_dir, File.basename(tagfile)))
            bag.add_tag_file(tagfile)
            # otherwise, add it
          else
            bag.add_tag_file(File.basename(tagfile), tagfile)
          end
        elsif opts['delete']
          bag.delete_tag_file(File.basename(tagfile))
        elsif opts['remove']
          bag.remove_tag_file(File.basename(tagfile))
        end
      rescue Exception => e
        puts "Failed operation on tag file: #{e.message}"
      end
    }
  end

  # if we haven't quit yet, we need to re-manifest
  # only do tags if tag files have been explictly added/removed or it is explictly called 
  bag.tagmanifest! if opts['-T'] or not opts['-t'].nil?
  bag.manifest!

rescue Docopt::Exit => e
  puts e.message
end

